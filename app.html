<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MatchQuant Soccer Engine</title>

  <style>
    :root{
      --bg1:#0b1633; --bg2:#050814; --card:#0f1a3a; --text:#ffffff;
      --muted:rgba(255,255,255,.65);
      --accent:#58a6ff; --accent2:#2f81f7;
      --border:rgba(255,255,255,.08);
      --shadow:0 16px 60px rgba(0,0,0,.55);
      --r:24px;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial, sans-serif;
      background:radial-gradient(circle at top, var(--bg1), var(--bg2));
      color:var(--text);
    }
    .wrap{max-width:920px; margin:0 auto; padding:16px}
    .topbar{display:flex; align-items:center; gap:12px; margin-bottom:12px}
    .homebtn{
      display:inline-flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.06); border:1px solid var(--border);
      color:#fff; padding:10px 14px; border-radius:999px;
      text-decoration:none; font-weight:700;
    }
    h1{margin:8px 0 2px; color:var(--accent); letter-spacing:.5px}
    .sub{margin:0 0 14px; color:var(--muted)}
    .panel{
      background:rgba(15,26,58,.92);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:16px;
      box-shadow:var(--shadow);
      margin-bottom:16px;
    }
    .title{
      font-size:28px; font-weight:900; color:var(--accent);
      margin:0 0 10px;
    }
    label{display:block; margin:10px 0 6px; color:var(--muted); font-weight:700}
    input, select{
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:#fff;
      outline:none;
      font-size:16px;
    }
    input::placeholder{color:rgba(255,255,255,.45)}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1; min-width:220px}
    .btn{
      width:100%;
      padding:14px 16px;
      border-radius:18px;
      border:none;
      background:linear-gradient(90deg, var(--accent2), var(--accent));
      color:#00102b;
      font-weight:900;
      font-size:18px;
      cursor:pointer;
      margin-top:12px;
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .mini{font-size:13px; color:var(--muted); margin-top:8px; line-height:1.35}
    .resultGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kv{
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(255,255,255,.04);
    }
    .k{font-weight:900}
    .v{float:right; color:rgba(255,255,255,.9); font-weight:800}
    .clear{clear:both}
    .badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      margin-right:8px;
    }
    .ok{background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35); color:#d1fae5}
    .warn{background:rgba(245,158,11,.18); border-color:rgba(245,158,11,.35); color:#ffedd5}
    .bad{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.35); color:#fee2e2}
    .loaderWrap{
      display:none;
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      align-items:center;
      gap:10px;
    }
    .spin{
      width:18px; height:18px; border-radius:50%;
      border:3px solid rgba(255,255,255,.2);
      border-top:3px solid var(--accent);
      animation:rot 0.8s linear infinite;
    }
    @keyframes rot{to{transform:rotate(360deg)}}

    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:16px; border:1px solid var(--border)}
    th,td{padding:10px 10px; border-bottom:1px solid var(--border); font-size:14px}
    th{background:rgba(255,255,255,.06); text-align:left}
    tr:last-child td{border-bottom:none}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .twoCols{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:760px){ .resultGrid, .twoCols{grid-template-columns:1fr} }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <a class="homebtn" href="./index.html">← Home</a>
      <div>
        <h1>MatchQuant</h1>
        <div class="sub">Soccer Prediction Engine (xG-based + Monte Carlo + EV flags)</div>
      </div>
    </div>

    <div class="panel">
      <div class="title">Mode 1 — Manual Match Input</div>

      <label>League</label>
      <select id="leaguePick"></select>
      <div class="mini">Pick league (uses that league’s xG table)</div>

      <button id="runAllBtn" class="btn">Run ALL Leagues at Once</button>
      <div class="mini">Runs each league fixture list (from <b>xg_tables.json</b>) and shows results below.</div>

      <label style="margin-top:14px">Home Team</label>
      <input id="homeTeam" placeholder="Home Team (e.g., Arsenal)" />

      <label>Away Team</label>
      <input id="awayTeam" placeholder="Away Team (e.g., Aston Villa)" />

      <div class="twoCols" style="margin-top:10px">
        <div class="kv">
          <div class="k">Monte Carlo sims <span class="v" id="mcSims">10,000</span></div>
          <div class="clear"></div>
          <div class="mini">Poisson goals + 10,000 simulations → score distribution + win probs</div>
        </div>

        <div class="kv">
          <div class="k">Optional Odds (for EV flags) <span class="v muted">decimal</span></div>
          <div class="clear"></div>
          <div class="mini">Fill what you have. EV will flag <span class="badge ok">Green</span><span class="badge warn">Yellow</span><span class="badge bad">Red</span></div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>ML Home Odds</label>
          <input id="oddsHome" placeholder="e.g., 1.95" inputmode="decimal" />
        </div>
        <div class="col">
          <label>ML Draw Odds</label>
          <input id="oddsDraw" placeholder="e.g., 3.60" inputmode="decimal" />
        </div>
        <div class="col">
          <label>ML Away Odds</label>
          <input id="oddsAway" placeholder="e.g., 3.90" inputmode="decimal" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>O/U 2.5 Odds (Over)</label>
          <input id="oddsO25" placeholder="e.g., 1.85" inputmode="decimal" />
        </div>
        <div class="col">
          <label>O/U 2.5 Odds (Under)</label>
          <input id="oddsU25" placeholder="e.g., 2.05" inputmode="decimal" />
        </div>
        <div class="col">
          <label>AH Home -0.5 Odds</label>
          <input id="oddsAHHome" placeholder="e.g., 2.05" inputmode="decimal" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Corners Line (e.g., 9.5)</label>
          <input id="cornLine" placeholder="e.g., 9.5" inputmode="decimal" />
        </div>
        <div class="col">
          <label>Corners Odds (Over)</label>
          <input id="oddsCornO" placeholder="e.g., 1.90" inputmode="decimal" />
        </div>
        <div class="col">
          <label>Corners Odds (Under)</label>
          <input id="oddsCornU" placeholder="e.g., 1.95" inputmode="decimal" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Cards Line (e.g., 4.5)</label>
          <input id="cardLine" placeholder="e.g., 4.5" inputmode="decimal" />
        </div>
        <div class="col">
          <label>Cards Odds (Over)</label>
          <input id="oddsCardO" placeholder="e.g., 1.85" inputmode="decimal" />
        </div>
        <div class="col">
          <label>Cards Odds (Under)</label>
          <input id="oddsCardU" placeholder="e.g., 2.05" inputmode="decimal" />
        </div>
      </div>

      <button id="predictBtn" class="btn">Run Prediction</button>

      <div id="loader" class="loaderWrap">
        <div class="spin"></div>
        <div><b>Loading / running simulations…</b> <span class="muted small" id="loaderMsg"></span></div>
      </div>

      <div class="panel" style="margin-top:16px">
        <div class="title" style="font-size:22px; margin-bottom:8px">Result</div>

        <div class="resultGrid">
          <div class="kv"><span class="k">League:</span> <span class="v" id="outLeague">—</span><div class="clear"></div></div>
          <div class="kv"><span class="k">Match:</span> <span class="v" id="outMatch">—</span><div class="clear"></div></div>
          <div class="kv"><span class="k">xG Used:</span> <span class="v" id="outXg">—</span><div class="clear"></div></div>
          <div class="kv"><span class="k">Predicted Score:</span> <span class="v" id="outScore">—</span><div class="clear"></div></div>
          <div class="kv"><span class="k">O/U 2.5:</span> <span class="v" id="outOU">—</span><div class="clear"></div></div>
          <div class="kv"><span class="k">Asian Handicap:</span> <span class="v" id="outAH">—</span><div class="clear"></div></div>
          <div class="kv"><span class="k">Corners:</span> <span class="v" id="outCorners">—</span><div class="clear"></div></div>
          <div class="kv"><span class="k">Cards:</span> <span class="v" id="outCards">—</span><div class="clear"></div></div>
        </div>

        <div class="kv" style="margin-top:10px">
          <div class="k">Win Probabilities <span class="v" id="outWin">—</span></div>
          <div class="clear"></div>
          <div class="mini" id="outWinNote"></div>
        </div>

        <div class="twoCols" style="margin-top:12px">
          <div class="kv">
            <div class="k">Monte Carlo Score Distribution (Top 8)</div>
            <div class="clear"></div>
            <div class="mini muted" id="outDistMeta"></div>
            <table style="margin-top:10px">
              <thead><tr><th>Score</th><th>Chance</th></tr></thead>
              <tbody id="distTable"></tbody>
            </table>
          </div>

          <div class="kv">
            <div class="k">Last H2H (if available)</div>
            <div class="clear"></div>
            <div class="mini muted">Pulled from <b>xg_tables.json</b> → <code>h2h_last</code></div>
            <table style="margin-top:10px">
              <thead><tr><th>Item</th><th>Value</th></tr></thead>
              <tbody id="h2hTable"></tbody>
            </table>
          </div>
        </div>

        <div class="kv" style="margin-top:12px">
          <div class="k">EV Flags (based on your odds)</div>
          <div class="clear"></div>
          <div class="mini muted">Green = positive edge, Yellow = small/neutral, Red = negative</div>
          <div id="evFlags" style="margin-top:10px"></div>
        </div>

        <div class="mini" style="margin-top:10px" id="loadedNote">Loading xG tables…</div>
      </div>
    </div>

    <div class="panel">
      <div class="title" style="font-size:22px">Auto Fixtures Results</div>
      <div class="mini muted">This runs when you tap <b>Run ALL Leagues at Once</b>. Fixtures come from <b>xg_tables.json</b>.</div>
      <div style="overflow:auto; margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>League</th>
              <th>Match</th>
              <th>λ (H / A)</th>
              <th>Pred</th>
              <th>H/D/A</th>
              <th>O2.5%</th>
              <th>EV Tags</th>
            </tr>
          </thead>
          <tbody id="allLeaguesTable">
            <tr><td class="muted" colspan="7">No results yet.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

<script>
/** =========================
 *  MatchQuant vNext
 *  Upgrades included:
 *  1) Monte Carlo (10,000 sims) score distribution
 *  2) Last H2H (score/corners/cards) if provided in JSON
 *  3) EV flags (green/yellow/red) based on model probs + user odds
 *  4) Auto fixtures per league (from JSON)
 *  ========================= */

const MC_SIMS = 10000;

let DB = null; // loaded from xg_tables.json once

const $ = (id) => document.getElementById(id);

function showLoader(msg){
  $("loaderMsg").textContent = msg || "";
  $("loader").style.display = "flex";
}
function hideLoader(){
  $("loader").style.display = "none";
  $("loaderMsg").textContent = "";
}

function normTeam(s){
  return (s || "").trim();
}

function safeNum(x){
  const n = parseFloat(x);
  return Number.isFinite(n) ? n : null;
}

function poissonSample(lambda){
  // Knuth
  const L = Math.exp(-lambda);
  let k = 0, p = 1;
  do { k++; p *= Math.random(); } while (p > L);
  return k - 1;
}

function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

function buildLeagueOptions(){
  const sel = $("leaguePick");
  sel.innerHTML = "";
  const leagues = Object.keys(DB.leagues || {});
  leagues.forEach((lg) => {
    const opt = document.createElement("option");
    opt.value = lg;
    opt.textContent = lg;
    sel.appendChild(opt);
  });
}

function getTeamRow(league, team){
  const lg = DB.leagues?.[league];
  if(!lg) return null;
  return lg[team] || null;
}

function getLambdas(league, home, away){
  const h = getTeamRow(league, home);
  const a = getTeamRow(league, away);
  if(!h || !a) return { ok:false, msg:"Team not found in xG table. Names must match exactly." };

  // Minimal: we assume xg_for and xg_against exist.
  // Simple blend: home attack vs away defense, away attack vs home defense
  const homeLambda = (h.xg_for + a.xg_against) / 2;
  const awayLambda = (a.xg_for + h.xg_against) / 2;

  return {
    ok:true,
    homeLambda: clamp(homeLambda, 0.05, 4.5),
    awayLambda: clamp(awayLambda, 0.05, 4.5),
    h, a
  };
}

function mcSim(homeLambda, awayLambda, sims=MC_SIMS){
  let homeW=0, draw=0, awayW=0;
  let goalsTotalOver25=0;
  const dist = new Map();
  let sumH=0, sumA=0;

  for(let i=0;i<sims;i++){
    const hg = poissonSample(homeLambda);
    const ag = poissonSample(awayLambda);
    sumH += hg; sumA += ag;

    if(hg>ag) homeW++;
    else if(hg===ag) draw++;
    else awayW++;

    if(hg+ag >= 3) goalsTotalOver25++;

    const key = `${hg}-${ag}`;
    dist.set(key, (dist.get(key)||0)+1);
  }

  const pH = homeW/sims, pD = draw/sims, pA = awayW/sims;
  const pO25 = goalsTotalOver25/sims;
  const meanH = sumH/sims, meanA = sumA/sims;

  // top scores
  const top = Array.from(dist.entries())
    .sort((a,b)=>b[1]-a[1])
    .slice(0,8)
    .map(([score,c]) => ({score, p:c/sims}));

  return {pH,pD,pA,pO25,meanH,meanA,top};
}

function pickScoreFromMeans(meanH, meanA){
  // nearest integer as "pred score"
  const hg = Math.round(meanH);
  const ag = Math.round(meanA);
  return `${hg}-${ag}`;
}

function cornersCardsLean(league, home, away){
  // Optional: if data exists, use it, otherwise fallback defaults
  const h = getTeamRow(league, home);
  const a = getTeamRow(league, away);

  const hc = h?.corners_for ?? null;
  const ha = h?.corners_against ?? null;
  const ac = a?.corners_for ?? null;
  const aa = a?.corners_against ?? null;

  const hCards = h?.cards_for ?? null;
  const hCardsA = h?.cards_against ?? null;
  const aCards = a?.cards_for ?? null;
  const aCardsA = a?.cards_against ?? null;

  const cornersExp =
    (hc!=null && aa!=null && ac!=null && ha!=null)
      ? ((hc + aa)/2 + (ac + ha)/2)
      : null;

  const cardsExp =
    (hCards!=null && aCardsA!=null && aCards!=null && hCardsA!=null)
      ? ((hCards + aCardsA)/2 + (aCards + hCardsA)/2)
      : null;

  return {cornersExp, cardsExp};
}

function flagFromEV(ev){
  // ev = p*odds - 1
  if(ev >= 0.05) return "ok";
  if(ev >= -0.02) return "warn";
  return "bad";
}

function evBlock(label, ev){
  const cls = flagFromEV(ev);
  const pct = (ev*100).toFixed(1);
  return `<span class="badge ${cls}"><b>${label}</b> EV ${pct}%</span>`;
}

function maybeEV(p, odds){
  if(p==null || odds==null) return null;
  return p*odds - 1;
}

function renderH2H(home, away){
  const tbody = $("h2hTable");
  tbody.innerHTML = "";
  const key = `${home}__${away}`;
  const key2 = `${away}__${home}`;
  const h2h = DB.h2h_last?.[key] || DB.h2h_last?.[key2] || null;

  const rows = [];
  if(!h2h){
    rows.push(["Status","No H2H stored yet"]);
  }else{
    rows.push(["Date", h2h.date || "—"]);
    rows.push(["Score", h2h.score || "—"]);
    rows.push(["Corners (total)", (h2h.corners_total ?? "—")]);
    rows.push(["Cards (total)", (h2h.cards_total ?? "—")]);
    rows.push(["Notes", h2h.notes || "—"]);
  }

  rows.forEach(([k,v])=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${k}</td><td>${v}</td>`;
    tbody.appendChild(tr);
  });
}

function renderDist(top, meta){
  $("outDistMeta").textContent = meta || "";
  const tbody = $("distTable");
  tbody.innerHTML = "";
  top.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.score}</td><td>${(r.p*100).toFixed(1)}%</td>`;
    tbody.appendChild(tr);
  });
}

function renderEVFlags(model){
  // Model contains: pH pD pA pO25 and home/away names and lambdas
  const el = $("evFlags");
  el.innerHTML = "";

  const oddsHome = safeNum($("oddsHome").value);
  const oddsDraw = safeNum($("oddsDraw").value);
  const oddsAway = safeNum($("oddsAway").value);
  const oddsO25 = safeNum($("oddsO25").value);
  const oddsU25 = safeNum($("oddsU25").value);
  const oddsAHHome = safeNum($("oddsAHHome").value);

  const cornLine = safeNum($("cornLine").value);
  const oddsCornO = safeNum($("oddsCornO").value);
  const oddsCornU = safeNum($("oddsCornU").value);

  const cardLine = safeNum($("cardLine").value);
  const oddsCardO = safeNum($("oddsCardO").value);
  const oddsCardU = safeNum($("oddsCardU").value);

  // ML EV
  const evH = maybeEV(model.pH, oddsHome);
  const evD = maybeEV(model.pD, oddsDraw);
  const evA = maybeEV(model.pA, oddsAway);

  // OU 2.5 EV (model has pO25)
  const evO = maybeEV(model.pO25, oddsO25);
  const evU = maybeEV(1-model.pO25, oddsU25);

  // AH -0.5 approx = win prob (same as home ML win, not including draw)
  const evAH = maybeEV(model.pH, oddsAHHome);

  // Corners / Cards: if we have expectations, approximate probability with normal-ish heuristic (simple)
  // This is a lightweight placeholder, you can improve later.
  const {cornersExp, cardsExp} = model;
  const approxProbOverLine = (exp, line) => {
    if(exp==null || line==null) return null;
    // soft probability: 0.5 at exp=line, slope ~ 0.25 per 1 unit
    const z = (exp - line) * 0.9;
    return clamp(0.5 + 0.22 * z, 0.02, 0.98);
  };

  const pCornO = approxProbOverLine(cornersExp, cornLine);
  const pCardO = approxProbOverLine(cardsExp, cardLine);

  const evCornO = maybeEV(pCornO, oddsCornO);
  const evCornU = (pCornO!=null && oddsCornU!=null) ? maybeEV(1-pCornO, oddsCornU) : null;

  const evCardO = maybeEV(pCardO, oddsCardO);
  const evCardU = (pCardO!=null && oddsCardU!=null) ? maybeEV(1-pCardO, oddsCardU) : null;

  const blocks = [];

  if(evH!=null) blocks.push(evBlock("ML Home", evH));
  if(evD!=null) blocks.push(evBlock("ML Draw", evD));
  if(evA!=null) blocks.push(evBlock("ML Away", evA));

  if(evO!=null) blocks.push(evBlock("Over 2.5", evO));
  if(evU!=null) blocks.push(evBlock("Under 2.5", evU));

  if(evAH!=null) blocks.push(evBlock("AH Home -0.5", evAH));

  if(evCornO!=null) blocks.push(evBlock(`Corners O${cornLine}`, evCornO));
  if(evCornU!=null) blocks.push(evBlock(`Corners U${cornLine}`, evCornU));

  if(evCardO!=null) blocks.push(evBlock(`Cards O${cardLine}`, evCardO));
  if(evCardU!=null) blocks.push(evBlock(`Cards U${cardLine}`, evCardU));

  if(blocks.length===0){
    el.innerHTML = `<span class="muted">No odds entered yet — add odds above to get EV flags.</span>`;
  }else{
    el.innerHTML = blocks.join(" ");
  }
}

function setOutputs({league, home, away, homeLambda, awayLambda, mc, cornersExp, cardsExp}){
  $("outLeague").textContent = league;
  $("outMatch").textContent = `${home} vs ${away}`;
  $("outXg").textContent = `Home λ ${homeLambda.toFixed(2)} / Away λ ${awayLambda.toFixed(2)}`;

  const score = pickScoreFromMeans(mc.meanH, mc.meanA);
  $("outScore").textContent = score;

  $("outOU").textContent = (mc.pO25 >= 0.52) ? "Over" : (mc.pO25 <= 0.48 ? "Under" : "Lean Over");
  // AH: if home win prob strong then -0.5 else DNB lean
  $("outAH").textContent = (mc.pH >= 0.52) ? "Home -0.5" : "0 (Draw No Bet lean)";

  // Corners/Cards leans
  const cornLean = cornersExp==null ? "—" : (cornersExp >= 10 ? "Over 9.5" : (cornersExp <= 9 ? "Under 9.5" : "Tight"));
  const cardLean = cardsExp==null ? "—" : (cardsExp >= 4.8 ? "Over 4.5" : (cardsExp <= 4.2 ? "Under 4.5" : "Tight"));
  $("outCorners").textContent = cornLean;
  $("outCards").textContent = cardLean;

  $("outWin").textContent = `H ${(mc.pH*100).toFixed(0)}% / D ${(mc.pD*100).toFixed(0)}% / A ${(mc.pA*100).toFixed(0)}%`;
  $("outWinNote").textContent = `Monte Carlo sims: ${MC_SIMS.toLocaleString()} | Over 2.5 prob: ${(mc.pO25*100).toFixed(1)}%`;

  renderDist(mc.top, `Means: H ${mc.meanH.toFixed(2)} | A ${mc.meanA.toFixed(2)} | O2.5 ${(mc.pO25*100).toFixed(1)}%`);
  renderH2H(home, away);

  renderEVFlags({
    pH: mc.pH, pD: mc.pD, pA: mc.pA, pO25: mc.pO25,
    cornersExp, cardsExp
  });

  $("loadedNote").textContent = `xG tables loaded ✓ (${Object.keys(DB.leagues||{}).length} leagues)`;
}

async function loadDB(){
  if(DB) return DB;
  showLoader("Fetching xg_tables.json");
  const res = await fetch("./xg_tables.json", {cache:"no-store"});
  if(!res.ok) throw new Error("Could not load xg_tables.json");
  DB = await res.json();
  buildLeagueOptions();
  hideLoader();
  return DB;
}

async function runSingle(){
  await loadDB();
  const league = $("leaguePick").value;
  const home = normTeam($("homeTeam").value);
  const away = normTeam($("awayTeam").value);

  if(!home || !away){
    alert("Type BOTH Home Team and Away Team.");
    return;
  }

  showLoader("Running Monte Carlo…");

  const lam = getLambdas(league, home, away);
  if(!lam.ok){
    hideLoader();
    alert(lam.msg);
    return;
  }

  const {cornersExp, cardsExp} = cornersCardsLean(league, home, away);
  const mc = mcSim(lam.homeLambda, lam.awayLambda, MC_SIMS);

  setOutputs({league, home, away, homeLambda:lam.homeLambda, awayLambda:lam.awayLambda, mc, cornersExp, cardsExp});
  hideLoader();
}

function getFixtureList(league){
  return DB.fixtures?.[league] || [];
}

function evTagsCompact(model, oddsObj){
  // oddsObj can be empty
  const tags = [];
  const evH = maybeEV(model.pH, oddsObj.mlHome);
  const evO = maybeEV(model.pO25, oddsObj.o25);

  if(evH!=null) tags.push(`<span class="badge ${flagFromEV(evH)}">MLH</span>`);
  if(evO!=null) tags.push(`<span class="badge ${flagFromEV(evO)}">O2.5</span>`);
  return tags.length ? tags.join(" ") : `<span class="muted small">—</span>`;
}

async function runAllLeagues(){
  await loadDB();
  showLoader("Running ALL leagues fixtures…");

  const tbody = $("allLeaguesTable");
  tbody.innerHTML = "";

  const leagues = Object.keys(DB.leagues || {});
  let anyRow = false;

  for(const league of leagues){
    const fixtures = getFixtureList(league);
    for(const fx of fixtures){
      const home = fx.home, away = fx.away;
      const lam = getLambdas(league, home, away);
      if(!lam.ok) continue;

      const mc = mcSim(lam.homeLambda, lam.awayLambda, 4000); // faster for bulk
      const score = pickScoreFromMeans(mc.meanH, mc.meanA);

      // Optional odds for fixtures: fx.odds may include mlHome, o25 etc
      const oddsObj = fx.odds || {};
      const tags = evTagsCompact({pH:mc.pH,pO25:mc.pO25}, oddsObj);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${league}</td>
        <td>${home} vs ${away}</td>
        <td>${lam.homeLambda.toFixed(2)} / ${lam.awayLambda.toFixed(2)}</td>
        <td><b>${score}</b></td>
        <td>${(mc.pH*100).toFixed(0)}/${(mc.pD*100).toFixed(0)}/${(mc.pA*100).toFixed(0)}</td>
        <td>${(mc.pO25*100).toFixed(0)}%</td>
        <td>${tags}</td>
      `;
      tbody.appendChild(tr);
      anyRow = true;
    }
  }

  if(!anyRow){
    tbody.innerHTML = `<tr><td class="muted" colspan="7">No fixtures found. Add fixtures in xg_tables.json → "fixtures".</td></tr>`;
  }

  hideLoader();
}

$("predictBtn").addEventListener("click", runSingle);
$("runAllBtn").addEventListener("click", runAllLeagues);

// init
loadDB().catch(err=>{
  hideLoader();
  $("loadedNote").textContent = "Could not load xg_tables.json (check file name + commit).";
  console.error(err);
});
</script>

</body>
</html>
