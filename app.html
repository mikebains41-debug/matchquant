<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MatchQuant Soccer Engine</title>
  <link rel="manifest" href="manifest.json">

  <style>
    :root{
      --bg1:#0b1633; --bg2:#050814; --card:#0f1a3a; --text:#ffffff;
      --muted:#c9d4ff; --accent:#58a6ff; --accent2:#2f81f7;
      --border:rgba(255,255,255,.08); --shadow:0 20px 70px rgba(0,0,0,.55);
      --radius:24px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,sans-serif;
      background:radial-gradient(circle at top,var(--bg1),var(--bg2));
      color:var(--text);
      min-height:100vh;
      padding:14px;
    }
    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      max-width:980px;
      margin:0 auto 12px auto;
    }
    .homebtn{
      background:rgba(255,255,255,.08);
      border:1px solid var(--border);
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      text-decoration:none;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .title{
      font-size:20px;
      font-weight:900;
      color:var(--accent);
      letter-spacing:.2px;
      margin:0;
      flex:1;
      text-align:center;
    }
    .wrap{max-width:980px;margin:0 auto;}
    .panel{
      background:rgba(15,26,58,.92);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:18px;
      margin:14px 0;
    }
    h2{
      margin:0 0 12px 0;
      color:var(--accent);
      font-size:22px;
      font-weight:900;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    input{
      width:100%;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.08);
      color:#fff;
      outline:none;
      font-size:16px;
    }
    input::placeholder{color:rgba(255,255,255,.6)}
    .btn{
      width:100%;
      background:linear-gradient(90deg,var(--accent2),var(--accent));
      border:none;
      color:#00102a;
      font-weight:900;
      padding:14px 18px;
      border-radius:16px;
      cursor:pointer;
      font-size:18px;
      margin-top:10px;
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px;}
    .chip{
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 14px;
      font-size:16px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .k{font-weight:900;color:#eaf0ff}
    .v{color:var(--muted);font-weight:800; text-align:right;}
    .note{margin-top:10px;color:rgba(255,255,255,.65);font-size:13px;line-height:1.35;}
    .mini{font-size:13px;color:rgba(255,255,255,.7);margin-top:8px;}
    .cards{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px;}
    .matchCard{
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
    }
    .mcTitle{font-size:18px;font-weight:900}
    .mcLine{margin-top:6px;color:rgba(255,255,255,.85);font-weight:800}
    .badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(88,166,255,.16);
      border:1px solid rgba(88,166,255,.22);
      color:#d9ecff;
      font-weight:900;
      font-size:12px;
      margin-top:10px;
    }
    .status{margin-top:10px;font-size:13px;color:rgba(255,255,255,.7)}
  </style>
</head>

<body>
  <div class="topbar">
    <a class="homebtn" href="./index.html">← Home</a>
    <h1 class="title">MatchQuant Soccer Engine</h1>
    <div style="width:76px"></div>
  </div>

  <div class="wrap">

    <!-- MODE 1 -->
    <div class="panel">
      <h2>Mode 1 — Manual Match Input</h2>

      <div class="row">
        <div style="flex:1; min-width:220px;">
          <input id="homeTeam" placeholder="Home Team (e.g., Arsenal)" />
        </div>
        <div style="flex:1; min-width:220px;">
          <input id="awayTeam" placeholder="Away Team (e.g., Aston Villa)" />
        </div>
      </div>

      <button class="btn" onclick="runManual()">Run Prediction</button>

      <div class="grid" id="manualOut">
        <div class="chip"><span class="k">Match:</span><span class="v" id="m_match">—</span></div>
        <div class="chip"><span class="k">xG Used:</span><span class="v" id="m_xg">—</span></div>
        <div class="chip"><span class="k">Predicted Score:</span><span class="v" id="m_score">—</span></div>
        <div class="chip"><span class="k">Over / Under 2.5:</span><span class="v" id="m_ou">—</span></div>
        <div class="chip"><span class="k">Asian Handicap:</span><span class="v" id="m_ah">—</span></div>
        <div class="chip"><span class="k">Corners:</span><span class="v" id="m_corners">—</span></div>
        <div class="chip"><span class="k">Cards:</span><span class="v" id="m_cards">—</span></div>
        <div class="chip"><span class="k">Win Probabilities:</span><span class="v" id="m_probs">—</span></div>
      </div>

      <div class="status" id="xgStatus">Loading xG tables…</div>
      <div class="note">
        Real xG mode: pulls xG For / xG Against from <b>xg_tables.json</b> (same folder).
        If a team name doesn’t match, it falls back to baseline so the app never breaks.
      </div>
    </div>

    <!-- MODE 2 -->
    <div class="panel">
      <h2>Mode 2 — Auto Daily Picks</h2>
      <button class="btn" onclick="loadDaily()">Load Today’s Picks</button>
      <div class="mini">Edit the “TODAY_FIXTURES” list in the code to your real schedule later.</div>
      <div class="cards" id="dailyList"></div>
    </div>

    <!-- MODE 3 -->
    <div class="panel">
      <h2>Mode 3 — Combined Engine Output</h2>
      <button class="btn" onclick="runFull()">Run Full Engine</button>
      <div class="grid">
        <div class="chip"><span class="k">Predicted Score:</span><span class="v" id="f_score">—</span></div>
        <div class="chip"><span class="k">Over / Under 2.5:</span><span class="v" id="f_ou">—</span></div>
        <div class="chip"><span class="k">Asian Handicap:</span><span class="v" id="f_ah">—</span></div>
        <div class="chip"><span class="k">Corners:</span><span class="v" id="f_corners">—</span></div>
        <div class="chip"><span class="k">Cards:</span><span class="v" id="f_cards">—</span></div>
        <div class="chip"><span class="k">Win Probabilities:</span><span class="v" id="f_probs">—</span></div>
      </div>
      <div class="note">Mode 3 just runs the same model as Mode 1, but as a “single-click engine”.</div>
    </div>

  </div>

<script>
/* ===================== 1) LOAD REAL xG TABLES ===================== */
let XG_DB = null;

(async function boot(){
  try{
    const res = await fetch("./xg_tables.json", { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    XG_DB = data?.teams || {};
    document.getElementById("xgStatus").textContent =
      "xG tables loaded ✅ (" + Object.keys(XG_DB).length + " teams)";
  }catch(e){
    XG_DB = null;
    document.getElementById("xgStatus").textContent =
      "xG tables NOT loaded ⚠️ (using fallback). Check xg_tables.json exists in repo.";
  }
})();

/* ===================== 2) CORE MODEL HELPERS ===================== */
const HOME_XG_BONUS = 0.12;      // small home lift
const BASE_XG_FALLBACK = 1.25;   // if team missing
const SIMS = 7000;               // phone safe

function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function pct(x){ return Math.round(x*100) + "%"; }

function poisson(lambda){
  const L = Math.exp(-lambda);
  let k=0, p=1;
  do{ k++; p *= Math.random(); } while(p > L);
  return k-1;
}

function getTeamXG(teamName){
  const row = XG_DB?.[teamName];
  if(!row) return null;
  const xg_for = Number(row.xg_for);
  const xg_against = Number(row.xg_against);
  if(!isFinite(xg_for) || !isFinite(xg_against)) return null;
  return { xg_for, xg_against };
}

/**
 * Matchup xG:
 * home_lambda = avg(home xG_for, away xG_against) + home bonus
 * away_lambda = avg(away xG_for, home xG_against)
 * If missing, use fallback baseline.
 */
function estimateXG(homeName, awayName){
  const h = getTeamXG(homeName);
  const a = getTeamXG(awayName);

  const h_for = h ? h.xg_for : BASE_XG_FALLBACK;
  const h_against = h ? h.xg_against : BASE_XG_FALLBACK;

  const a_for = a ? a.xg_for : BASE_XG_FALLBACK;
  const a_against = a ? a.xg_against : BASE_XG_FALLBACK;

  let homeLambda = ((h_for + a_against) / 2) + HOME_XG_BONUS;
  let awayLambda = ((a_for + h_against) / 2);

  // clamp to keep stable
  homeLambda = clamp(homeLambda, 0.25, 2.80);
  awayLambda = clamp(awayLambda, 0.25, 2.80);

  return { homeLambda, awayLambda, h, a };
}

function simulateMatch(homeLambda, awayLambda){
  let homeW=0, draw=0, awayW=0;
  let bestScore = {h:0,a:0,p:0};
  let over25=0;

  for(let i=0;i<SIMS;i++){
    const hg = poisson(homeLambda);
    const ag = poisson(awayLambda);

    if(hg>ag) homeW++;
    else if(hg===ag) draw++;
    else awayW++;

    if(hg+ag>2) over25++;

    // track most common score (rough)
    // (we approximate by counting probability weight 1/SIMS)
    // store if higher occurrence
    const key = hg + "-" + ag;
    // light trick: stash in map
  }

  // We want a proper mode score → run a quick frequency map:
  const freq = {};
  for(let i=0;i<SIMS;i++){
    const hg = poisson(homeLambda);
    const ag = poisson(awayLambda);
    const key = hg + "-" + ag;
    freq[key] = (freq[key]||0)+1;
  }
  for(const k in freq){
    if(freq[k] > bestScore.p){
      const parts = k.split("-");
      bestScore = {h:Number(parts[0]), a:Number(parts[1]), p:freq[k]};
    }
  }

  const total = SIMS;
  const pHome = homeW/total;
  const pDraw = draw/total;
  const pAway = awayW/total;
  const pOver = over25/total;

  // Markets:
  const predictedTotal = homeLambda + awayLambda;
  const ou = (pOver >= 0.52 || predictedTotal >= 2.65) ? "Over" : "Under";

  const ah =
    (pHome > pAway && pHome >= 0.48) ? "Home -0.5" :
    (pAway > pHome && pAway >= 0.48) ? "Away +0.5" :
    "0 (Draw No Bet lean)";

  // Corners & cards (simple scaling off tempo / total xG)
  const cornersLine = predictedTotal >= 2.60 ? "Over 8.5" : "Under 9.5";
  const cardsLine = predictedTotal >= 2.70 ? "Over 3.5" : "Under 4.5";

  return {
    score: `${bestScore.h}–${bestScore.a}`,
    ou,
    ah,
    corners: cornersLine,
    cards: cardsLine,
    probs: `H ${pct(pHome)} / D ${pct(pDraw)} / A ${pct(pAway)}`
  };
}

/* ===================== 3) MODE 1 ===================== */
function runManual(){
  const home = (document.getElementById("homeTeam").value || "Home").trim();
  const away = (document.getElementById("awayTeam").value || "Away").trim();

  document.getElementById("m_match").textContent = `${home} vs ${away}`;

  const { homeLambda, awayLambda, h, a } = estimateXG(home, away);
  const out = simulateMatch(homeLambda, awayLambda);

  const used =
    `Home λ ${homeLambda.toFixed(2)} / Away λ ${awayLambda.toFixed(2)}` +
    ` | Table: ${(h? "home✓":"home×")} ${(a? "away✓":"away×")}`;

  document.getElementById("m_xg").textContent = used;
  document.getElementById("m_score").textContent = out.score;
  document.getElementById("m_ou").textContent = out.ou;
  document.getElementById("m_ah").textContent = out.ah;
  document.getElementById("m_corners").textContent = out.corners;
  document.getElementById("m_cards").textContent = out.cards;
  document.getElementById("m_probs").textContent = out.probs;
}

/* ===================== 4) MODE 2 ===================== */
const TODAY_FIXTURES = [
  { home:"Arsenal", away:"Aston Villa" },
  { home:"Inter", away:"Genoa" },
  { home:"Real Betis", away:"Getafe" }
];

function loadDaily(){
  const list = document.getElementById("dailyList");
  list.innerHTML = "";

  TODAY_FIXTURES.forEach(fx => {
    const { homeLambda, awayLambda } = estimateXG(fx.home, fx.away);
    const out = simulateMatch(homeLambda, awayLambda);

    const div = document.createElement("div");
    div.className = "matchCard";
    div.innerHTML = `
      <div class="mcTitle">${fx.home} vs ${fx.away}</div>
      <div class="mcLine">Score: <b>${out.score}</b></div>
      <div class="mcLine">O/U 2.5: <b>${out.ou}</b></div>
      <div class="mcLine">AH: <b>${out.ah}</b></div>
      <div class="mcLine">Corners: <b>${out.corners}</b></div>
      <div class="mcLine">Cards: <b>${out.cards}</b></div>
      <div class="badge">${out.probs}</div>
    `;
    list.appendChild(div);
  });
}

/* ===================== 5) MODE 3 ===================== */
function runFull(){
  // Runs engine using whatever is typed. If empty, uses placeholders.
  const home = (document.getElementById("homeTeam").value || "Home").trim();
  const away = (document.getElementById("awayTeam").value || "Away").trim();

  const { homeLambda, awayLambda } = estimateXG(home, away);
  const out = simulateMatch(homeLambda, awayLambda);

  document.getElementById("f_score").textContent = out.score;
  document.getElementById("f_ou").textContent = out.ou;
  document.getElementById("f_ah").textContent = out.ah;
  document.getElementById("f_corners").textContent = out.corners;
  document.getElementById("f_cards").textContent = out.cards;
  document.getElementById("f_probs").textContent = out.probs;
}
</script>

</body>
</html>
