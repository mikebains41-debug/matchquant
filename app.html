<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MatchQuant Soccer Engine</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg1:#0b1633; --bg2:#050814; --card:#0f1a3a; --text:#ffffff;
      --muted:#c9d4ff; --accent:#58a6ff; --accent2:#2f81f7;
      --border:rgba(255,255,255,.08); --shadow:0 20px 70px rgba(0,0,0,.55);
      --radius:24px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,sans-serif;background:radial-gradient(circle at top,var(--bg1),var(--bg2));color:var(--text);min-height:100vh;padding:14px;}
    .topbar{display:flex;align-items:center;gap:12px;max-width:920px;margin:0 auto 12px auto;}
    .homebtn{background:rgba(255,255,255,.08);border:1px solid var(--border);color:#fff;padding:10px 14px;border-radius:14px;text-decoration:none;font-weight:700;display:inline-flex;align-items:center;gap:8px;}
    .title{font-size:20px;font-weight:900;color:var(--accent);letter-spacing:.2px;margin:0;flex:1;text-align:center;}
    .wrap{max-width:920px;margin:0 auto;}
    .panel{background:rgba(15,26,58,.92);border:1px solid var(--border);box-shadow:var(--shadow);border-radius:var(--radius);padding:18px;margin:14px 0;}
    h2{margin:0 0 12px 0;color:var(--accent);font-size:22px;font-weight:900;}
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    input{width:100%;padding:14px 14px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.08);color:#fff;outline:none;font-size:16px;}
    input::placeholder{color:rgba(255,255,255,.6)}
    .btn{width:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));border:none;color:#00102a;font-weight:900;padding:14px 18px;border-radius:16px;cursor:pointer;font-size:18px;margin-top:10px;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px;}
    .chip{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:16px;padding:12px 14px;font-size:18px;display:flex;justify-content:space-between;gap:10px;align-items:center;}
    .k{font-weight:900;color:#eaf0ff}
    .v{color:var(--muted);font-weight:800}
    .note{margin-top:10px;color:rgba(255,255,255,.65);font-size:13px;line-height:1.35;}
    .mini{font-size:13px;color:rgba(255,255,255,.7);margin-top:8px;}
    .cards{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px;}
    .matchCard{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:18px;padding:14px;}
    .mcTitle{font-size:18px;font-weight:900}
    .mcLine{margin-top:6px;color:rgba(255,255,255,.85);font-weight:700}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(88,166,255,.16);border:1px solid rgba(88,166,255,.22);color:#d9ecff;font-weight:900;font-size:12px;margin-top:10px;}
    .status{margin-top:10px;font-size:13px;color:rgba(255,255,255,.7)}
  </style>
</head>

<body>
  <div class="topbar">
    <a class="homebtn" href="./index.html">← Home</a>
    <h1 class="title">MatchQuant Soccer Engine</h1>
    <div style="width:76px"></div>
  </div>

  <div class="wrap">
    <div class="panel">
      <h2>Mode 1 — Manual Match Input</h2>
      <div class="row">
        <div style="flex:1; min-width:220px;">
          <input id="homeTeam" placeholder="Home Team (e.g., Arsenal)" />
        </div>
        <div style="flex:1; min-width:220px;">
          <input id="awayTeam" placeholder="Away Team (e.g., Aston Villa)" />
        </div>
      </div>
      <button class="btn" onclick="runManual()">Run Prediction</button>

      <div class="grid" id="manualOut">
        <div class="chip"><span class="k">Match:</span><span class="v" id="m_match">Home vs Away</span></div>
        <div class="chip"><span class="k">xG Used:</span><span class="v" id="m_xg">—</span></div>
        <div class="chip"><span class="k">Predicted Score:</span><span class="v" id="m_score">—</span></div>
        <div class="chip"><span class="k">Over / Under 2.5:</span><span class="v" id="m_ou">—</span></div>
        <div class="chip"><span class="k">Asian Handicap:</span><span class="v" id="m_ah">—</span></div>
        <div class="chip"><span class="k">Corners:</span><span class="v" id="m_corners">—</span></div>
        <div class="chip"><span class="k">Cards:</span><span class="v" id="m_cards">—</span></div>
        <div class="chip"><span class="k">Win Probabilities:</span><span class="v" id="m_probs">—</span></div>
      </div>

      <div class="status" id="xgStatus">Loading xG tables…</div>
      <div class="note">
        Real xG mode: pulls xG For / xG Against from <b>xg_tables.json</b>.
        If a team isn’t found, it falls back to a baseline estimate so the app never breaks.
      </div>
    </div>

    <div class="panel">
      <h2>Mode 2 — Auto Daily Picks</h2>
      <button class="btn" onclick="loadDaily()">Load Today’s Picks</button>
      <div class="mini">Demo fixtures shown. You can change the fixture list in the code later.</div>
      <div class="cards" id="dailyList"></div>
    </div>

    <div class="panel">
      <h2>Mode 3 — Combined Engine Output</h2>
      <button class="btn" onclick="runFull()">Run Full Engine</button>
      <div class="grid">
        <div class="chip"><span class="k">Predicted Score:</span><span class="v" id="f_score">—</span></div>
        <div class="chip"><span class="k">Over / Under 2.5:</span><span class="v" id="f_ou">—</span></div>
        <div class="chip"><span class="k">Asian Handicap:</span><span class="v" id="f_ah">—</span></div>
        <div class="chip"><span class="k">Corners:</span><span class="v" id="f_corners">—</span></div>
        <div class="chip"><span class="k">Cards:</span><span class="v" id="f_cards">—</span></div>
        <div class="chip"><span class="k">Win Probabilities:</span><span class="v" id="f_probs">—</span></div>
      </div>
    </div>
  </div>

<script>
/* ---------------- REAL xG TABLE LOADER ---------------- */
let XG_DB = null;

// load xg_tables.json from same folder as app.html
(async function boot(){
  try{
    const res = await fetch("./xg_tables.json", { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    XG_DB = data?.teams || {};
    document.getElementById("xgStatus").textContent =
      "xG tables loaded ✅ (" + Object.keys(XG_DB).length + " teams)";
  }catch(e){
    XG_DB = null;
    document.getElementById("xgStatus").textContent =
      "xG tables NOT loaded ⚠️ (using fallback). Check xg_tables.json file exists.";
  }
})();

/* ------------- CORE MODEL ------------- */
const HOME_XG_BONUS = 0.12;     // small home lift
const BASE_XG_FALLBACK = 1.25;  // if team missing
const SIMS = 9000;              // Monte Carlo (phone safe)

function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function pct(x){ return Math.round(x*100) + "%"; }

function poisson(lambda){
  const L = Math.exp(-lambda);
  let k=0, p=1;
  do{ k++; p *= Math.random(); }while(p > L);
  return k-1;
}

/**
 * Real xG method:
 * - home_xg_for (from table) vs away_xg_against (from table)
 * - away_xg_for vs home_xg_against
 * We average them to get a fair matchup xG.
 */
function getTeamXG(name){
  const row = XG_DB?.[name];
  if(!row) return null;
  const xg_for = Number(row.xg_for);
  const xg_against = Number(row.xg_against);
  if(!isFinite(xg_for) || !isFinite(xg_against)) return null;
  return { xg_for, xg_against };
}

function estimateXG(homeName, awayName){
  const H = getTeamXG(homeName);
  const A = getTeamXG(awayName);

  let hxg, axg, used = "fallback";

  if(H && A){
    // blend: (home attack + away defense) / 2, plus a small home bonus
    hxg = ((H.xg_for + A.xg_against) / 2) + HOME_XG_BONUS;
    axg = ((A.xg_for + H.xg_against) / 2);

    hxg = clamp(hxg, 0.35, 2.80);
    axg = clamp(axg, 0.35, 2.60);
    used = "real_xg";
  } else {
    // fallback if one/both teams missing in JSON
    hxg = BASE_XG_FALLBACK + HOME_XG_BONUS;
    axg = BASE_XG_FALLBACK;
    used = "fallback";
  }

  const tempo = clamp(hxg + axg, 1.2, 4.6);
  return { hxg, axg, tempo, used };
}

function simulateMatch(homeName, awayName){
  const { hxg, axg, tempo, used } = estimateXG(homeName, awayName);

  let homeW=0, draw=0, awayW=0, over25=0;
  const scoreMap = new Map();

  for(let i=0;i<SIMS;i++){
    const hg = poisson(hxg);
    const ag = poisson(axg);

    if(hg>ag) homeW++;
    else if(hg===ag) draw++;
    else awayW++;

    if(hg+ag >= 3) over25++;

    const key = hg + "-" + ag;
    scoreMap.set(key, (scoreMap.get(key)||0) + 1);
  }

  let bestScore="1-1", bestCount=-1;
  for(const [k,c] of scoreMap.entries()){
    if(c>bestCount){ bestCount=c; bestScore=k; }
  }

  const pHome = homeW/SIMS, pDraw = draw/SIMS, pAway = awayW/SIMS;
  const pOver = over25/SIMS;
  const ouLean = (pOver >= 0.52) ? "Over" : "Under";

  // AH heuristic from win probability
  let ah = "Home -0.25";
  if(pHome >= 0.60) ah = "Home -0.5";
  if(pHome >= 0.68) ah = "Home -0.75";
  if(pHome >= 0.75) ah = "Home -1.0";
  if(pAway >= 0.60) ah = "Away +0.5";
  if(pAway >= 0.68) ah = "Away +0.75";
  if(pAway >= 0.75) ah = "Away +1.0";
  if(pDraw >= 0.32) ah = "Draw No Bet (DNB)";

  // Corners/Cards quick proxy from tempo
  const cornersLine = (tempo >= 2.9) ? "Over 8.5" : "Under 9.5";
  const cardsLine   = (tempo >= 3.2) ? "Over 3.5" : "Under 4.5";

  return {
    scoreText: bestScore,
    ou: ouLean,
    ah,
    corners: cornersLine,
    cards: cardsLine,
    probs: `H ${pct(pHome)} / D ${pct(pDraw)} / A ${pct(pAway)}`,
    xgText: `${hxg.toFixed(2)}–${axg.toFixed(2)} (${used})`
  };
}

/* MODE 1 */
function runManual(){
  const home = (document.getElementById("homeTeam").value || "Home").trim();
  const away = (document.getElementById("awayTeam").value || "Away").trim();

  document.getElementById("m_match").textContent = `${home} vs ${away}`;

  const r = simulateMatch(home, away);
  document.getElementById("m_xg").textContent = r.xgText;
  document.getElementById("m_score").textContent = r.scoreText + " (Home–Away)";
  document.getElementById("m_ou").textContent = r.ou;
  document.getElementById("m_ah").textContent = r.ah;
  document.getElementById("m_corners").textContent = r.corners;
  document.getElementById("m_cards").textContent = r.cards;
  document.getElementById("m_probs").textContent = r.probs;
}

/* MODE 2 demo fixtures */
const DEMO_FIXTURES = [
  { home:"Arsenal", away:"Aston Villa" },
  { home:"Inter", away:"Genoa" },
  { home:"Betis", away:"Getafe" }
];

function loadDaily(){
  const box = document.getElementById("dailyList");
  box.innerHTML = "";

  DEMO_FIXTURES.forEach(fx=>{
    const r = simulateMatch(fx.home, fx.away);

    const card = document.createElement("div");
    card.className = "matchCard";
    card.innerHTML = `
      <div class="mcTitle">${fx.home} vs ${fx.away}</div>
      <div class="mcLine">xG Used: <b>${r.xgText}</b></div>
      <div class="mcLine">Score: <b>${r.scoreText}</b></div>
      <div class="mcLine">O/U 2.5: <b>${r.ou}</b></div>
      <div class="mcLine">AH: <b>${r.ah}</b></div>
      <div class="mcLine">Corners: <b>${r.corners}</b></div>
      <div class="mcLine">Cards: <b>${r.cards}</b></div>
      <div class="mcLine">Probs: <b>${r.probs}</b></div>
      <div class="badge">Auto Pick</div>
    `;
    box.appendChild(card);
  });
}

/* MODE 3 */
function runFull(){
  const home = (document.getElementById("homeTeam").value || "Arsenal").trim();
  const away = (document.getElementById("awayTeam").value || "Chelsea").trim();

  const r = simulateMatch(home, away);

  document.getElementById("f_score").textContent = `${home} vs ${away}: ${r.scoreText}`;
  document.getElementById("f_ou").textContent = r.ou;
  document.getElementById("f_ah").textContent = r.ah;
  document.getElementById("f_corners").textContent = r.corners;
  document.getElementById("f_cards").textContent = r.cards;
  document.getElementById("f_probs").textContent = r.probs;
}
</script>
</body>
</html>
